---
title: æ–°æ‰‹ä¸Šè·¯ä¹‹ SSH
description: æ–°æ‰‹ SSH å¤§è£œå¸–ï¼æƒ³çŸ¥é“å¦‚ä½•ä¿®æ”¹ Port ä¸”ä¸ç”¨è¼¸å…¥ IP åŠå¯†ç¢¼å°±é€²å…¥æ©Ÿå™¨å—ï¼Œé€²ä¾†å°±å°äº†ï¼
id: e5457b2a-030e-4562-96b0-bad230f9d8fc
publishedAt: 2023-Oct-30 17:43:58+08:00
modifiedAt: 2024-Apr-21 17:43:58+08:00
category: system
---

import { CustomImage, Callout, Admonition } from '@/components/custom-blog-components'

<CustomImage src='/images/newbie-ssh/ssh-ok.jpg' width={654} height={680} alt='SSH to remote? Right the way!'/>

ç›¸ä¿¡å¤§å®¶å°ã€ŒSSH é€²æ©Ÿå™¨ã€é€™å¥è©±è‚¯å®šä¸é™Œç”Ÿï¼Œä½†åœ¨å¯«é€™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘åªçŸ¥é“ SSH æ˜¯ç”±ä¸‰å€‹è‹±æ–‡å–®å­—çµ„æˆï¼Œå…¶ä»–çš„ä¸€æ¦‚ä¸çŸ¥ ğŸ«  æ‰€ä»¥ä»Šå¤©å°±è®“æˆ‘å€‘ä¾†äº†è§£ SSH çš„é­”æ³•ï¼Œä»¥åŠå¦‚ä½•æ›´æ–¹ä¾¿çš„ç”¨ SSH é€£ç·šå§ï¼

## èªªçœŸçš„ï¼ŒSSH æ˜¯ä»€éº¼

Secure Shell Protocol - åˆç¨± SSHï¼Œè®“ä½¿ç”¨è€…å¯ä»¥é€éå®‰å…¨çš„ç®¡é“ï¼Œæ“æ§åŠå­˜å–é ç«¯çš„ Serverã€‚åœ¨ macOS åŠ Linux ç³»çµ±ä¸­éƒ½æœ‰å…§å»º SSHï¼Œæ‰€ä»¥æˆ‘å€‘æ‰èƒ½ç›´æ¥ç”¨çµ‚ç«¯æ©Ÿä¾†é€£ç·šè‡³é ç«¯çš„ serverã€‚

```shell
ssh username@remote-server-ip
```
SSH é€£ç·šçš„éç¨‹ä¸­ï¼Œæœƒç¶“éäº”å€‹æ­¥é©Ÿã€‚æˆ‘å€‘å¯ä»¥åœ¨é€£ç·šæ™‚ç”¨ `-v`ã€`-vv` å’Œ `-vvv` option ä¾†æŸ¥çœ‹é€£ç·šçš„éç¨‹ï¼Œ`v` è¶Šå¤šè¶Šè©³ç´°ï¼ˆè¶Šå›‰å”†ï¼‰ã€‚

```shell
ssh -v username@remote-server-ip
```

æ¥è‘—å°±æœƒçœ‹åˆ° terminal å™´å‡ºä¸€å †è¨Šæ¯

```shell
OpenSSH_9.0p1, LibreSSL 3.3.6
debug1: Reading configuration data /Users/cooper/.ssh/config

...

debug1: channel 1: connected to /var/tmp/fig/cooper/secure.socket port -2
```

æ¥è‘—æˆ‘å€‘ä¾†æ‹†è§£æ¯ä¸€å€‹æ­¥é©Ÿï¼Œä¸¦å°ç…§åˆ°å‰›å‰›çš„è¨Šæ¯

### 1. å»ºç«‹ TCP é€£ç·š

<CustomImage src='/images/newbie-ssh/tcp-handshake.png' width={654} height={680} alt='TCP handshake diagram' caption='TCP three-way handshake diagram'/>

é¦–å…ˆï¼ŒClient æœƒå’Œ Server å»ºç«‹ TCP é€£ç·šã€‚Client å‘ Server é€å‡º synchronizeï¼ˆSYNï¼‰å°åŒ…ï¼Œå…¶ä¸­åŒ…å«äº† Client éš¨æ©Ÿç”¢ç”Ÿçš„åˆå§‹åºè™Ÿï¼ˆInitial Sequence Number, ISNï¼‰ã€‚

Server æ”¶åˆ° SYN å¾Œï¼Œä¾¿æœƒå°‡ Client çš„ Sequence Number åŠ  1 å¾Œä½œç‚º acknowledgeï¼ˆACKï¼‰ï¼Œå†åŠ ä¸Šè‡ªå·±ç”¢ç”Ÿçš„ sequence number å¾Œä¸€èµ·å›è¦†çµ¦ Clientï¼Œè¡¨ç¤º Server ç¢ºå¯¦æ”¶åˆ°ä¾†è‡ª Client çš„ SYNã€‚é€™å€‹å›è¦†é€šå¸¸æœƒè¨˜ä½œ **SYN-ACK** æˆ– **SYN/ACK**ã€‚

åœ¨é€™å…©å€‹æ­¥é©Ÿä¸­éƒ½è¨­æœ‰è¨ˆæ™‚å™¨ï¼Œè‹¥åœ¨ä¸€å®šçš„æ™‚é–“ä¸­æ²’æœ‰æ”¶åˆ°é æœŸçš„å›è¦†ï¼Œå‰‡æœƒè‡ªå‹•é‡æ–°å‚³é€å°åŒ…ã€‚

æ¥è‘— Client æ”¶åˆ°ä¾†è‡ª Server çš„ SYN-ACK å¾Œï¼Œä¹Ÿæœƒå°‡ Server çš„ Sequence Number åŠ  1ï¼Œä½œç‚º acknowledgeï¼ˆACKï¼‰ä¸¦å›è¦†çµ¦ Serverã€‚æ­¤æ™‚ TCP three-way handshake å°±å®Œæˆã€‚

æˆ‘å€‘å¯ä»¥åœ¨ terminal ä¸­çœ‹åˆ° **Connection established**ï¼Œè¡¨ç¤º TCP é€£ç·šå·²å»ºç«‹ã€‚

```shell
debug1: Connecting to remote-ip-address [remote-ip-address] port 22.
debug1: Connection established.
```

### 2. SSH Protocol Version Exchange

æ¥è‘— Server åŠ Client äº’ç›¸äº¤æ› SSH Protocol ç‰ˆæœ¬ï¼Œç¢ºèªç›¸å®¹æ€§ï¼Œä¸¦æ±ºå®šç”¨å“ªä¸€å€‹ç‰ˆæœ¬çš„ Protocol ä¾†æºé€šã€‚

å¾ terminal ä¸­ï¼Œå¯ä»¥çœ‹åˆ° Local çš„ SSH ç‰ˆæœ¬ç‚º OpenSSH_9.0ï¼Œè€Œ Remote çš„ SSH ç‰ˆæœ¬ç‚º OpenSSH_8.9p1ï¼Œæœ€å¾Œä½¿ç”¨ OpenSSH_8.9p1 ä¾†æºé€šã€‚

```shell
debug1: Local version string SSH-2.0-OpenSSH_9.0
debug1: Remote protocol version 2.0, remote software version OpenSSH_8.9p1 Ubuntu-3ubuntu0.3
debug1: compat_banner: match: OpenSSH_8.9p1 Ubuntu-3ubuntu0.3 pat OpenSSH* compat 0x04000000
```

### 3. Session Encryption Negotiation

ç•¶ SSH ç‰ˆæœ¬ç¢ºå®šå¾Œï¼Œå°±æœƒé–‹å§‹é€²è¡Œ Session Encryption Negotiationã€‚

æ­¤æ™‚ï¼ŒClient åŠ Server æœƒç”¢ç”Ÿæš«æ™‚æ€§çš„ private-public key pairsï¼Œä¸¦äº’ç›¸äº¤æ› public keyã€‚æ¥è‘—å„è‡ªé›™æ–¹æ‹¿è‘—å°æ–¹çš„ public key åŠè‡ªå·±çš„ private keyï¼Œé€é key exchange æ¼”ç®—æ³•ç¨ç«‹è¨ˆç®—å‡º shared secretã€‚é€™å€‹ shared secret æœƒè¢«ç”¨ä¾†åŠ å¯†æ•´å€‹ SSH session ä¸­å‚³è¼¸çš„è³‡æ–™ã€‚

æ¥è‘—å†å›åˆ° terminal è£¡é¢ç§ç§ï¼š

```shell
debug1: kex: algorithm: sntrup761x25519-sha512@openssh.com
debug1: kex: host key algorithm: ssh-ed25519
debug1: kex: server->client cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: kex: client->server cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
```

é¦–å…ˆï¼Œæœ€å‰é¢çš„ã€Œkexã€è¡¨ç¤º Key Exchangeã€‚

ç¬¬ä¸€è¡Œè¡¨ç¤º Client åŠ Server æœƒä½¿ç”¨ `sntrup761x25519-sha512@openssh.com` åšç‚ºç”¢ç”Ÿ shared secret çš„ key exchange æ¼”ç®—æ³•ã€‚ç¬¬äºŒè¡Œè¡¨ç¤ºç›®å‰ä½¿ç”¨è€…å˜—è©¦ç”¨ä¾†ç™»å…¥çš„ host key æ˜¯ç”± ssh-ed25519 æ¼”ç®—æ³•è¨ˆç®—å‡ºä¾†çš„ã€‚æœ€å¾Œï¼Œç¬¬ä¸‰åŠç¬¬å››è¡Œè¡¨ç¤º Client åŠ Server é›™æ–¹åŒæ„ä½¿ç”¨ `chacha20-poly1305@openssh.com` æ¼”ç®—æ³•ï¼Œä¸¦ä½¿ç”¨ shared secret åšç‚º keyï¼ŒåŠ å¯†æ•´å€‹ SSH session ä¸­çš„è¨Šæ¯ã€‚

### 4. User Authentication

åœ¨ Client åŠ server æ±ºå®šå¥½è¦ä½¿ç”¨å“ªä¸€å€‹ key exchange æ¼”ç®—æ³•ä¹‹å¾Œï¼Œä¾¿æœƒé–‹å§‹é€²è¡Œ User Authenticationã€‚

åœ¨ terminal è£¡é¢å¯ä»¥çœ‹åˆ° server æ”¯æ´çš„ authentication methods ç‚º publickey åŠå¯†ç¢¼å…©ç¨®ï¼Œæ­¤æ™‚æˆ‘å€‘ä»¥ publickey ä¾†é€²è¡Œé©—è­‰ã€‚åœ¨ Server æ¥æ”¶ key ä¹‹å¾Œï¼Œä½¿ç”¨è€…é©—è­‰å°±å®Œæˆäº†ï¼

```shell
debug1: Authentications that can continue: publickey,password
debug1: Next authentication method: publickey
debug1: Offering public key: ...
debug1: Server accepts key: ...
Authenticated to remote-server-address ([remote-server-address]:port) using "publickey".
```

### 5. å»ºç«‹ SSH tunnel

åœ¨ Server é©—è­‰ Client èº«ä»½ä¸”ç”¢ç”Ÿ shared secret ä¹‹å¾Œï¼ŒClient å’Œ Server ä¾¿å¯ä»¥ä½¿ç”¨ shared secret ä¾†åŠ å¯†åŠè§£å¯†å°åŒ…ã€‚æœ€å¾Œ server é–‹å•Ÿ shell environmentï¼Œè®“ client å¯ä»¥é€é shell ä¾†æ“ä½œ serverã€‚è€Œé€™å€‹è®“é›™æ–¹äº’ç›¸æºé€šçš„ã€Œé€šé“ã€ç¨±ç‚º SSH tunnelã€‚

æœ€å¾Œåœ¨ terminal ä¸­ï¼Œå¯ä»¥çœ‹åˆ° SSH tunnel å·²ç¶“å»ºç«‹å®Œæˆã€‚

```shell
debug1: channel 1: new [forwarded-streamlocal]
```

å¾é€™è£¡é–‹å§‹ï¼Œæ‰€æœ‰å‚³è¼¸çš„å°åŒ…éƒ½æœƒä½¿ç”¨ shared secret é€²è¡Œå°ç¨±å¼åŠ å¯†ã€‚æ•´å€‹å°åŒ…å¯ä»¥æ‹†è§£æˆäº”å€‹éƒ¨åˆ†ï¼š

- **Packet Length (4 bytes)** - è¡¨ç¤ºæ•´å€‹å°åŒ…çš„é•·åº¦ï¼Œä¸åŒ…å« MAC åŠ Packet Length æœ¬èº«ã€‚å¦‚æœ Payload æœ‰ç¶“éå£“ç¸®ï¼Œå‰‡æœƒè¨ˆç®—å£“ç¸®å¾Œçš„é•·åº¦
- **Padding length (1 byte)** - è¡¨ç¤º Padding field çš„é•·åº¦
- **Payload** - çœŸæ­£è¦å‚³è¼¸çš„è³‡æ–™ã€‚å¦‚æœæœ‰é€²è¡Œå£“ç¸®ï¼Œå‰‡åªæœƒå£“ç¸® Payload
- **Padding field** - Random bytesï¼Œæœƒå’ŒçœŸæ­£çš„è³‡æ–™ï¼ˆpayloadï¼‰ä¸€èµ·åŠ å¯†ï¼Œè®“çœŸå¯¦è³‡æ–™æ›´é›£è¢«æœ‰å¿ƒäººå£«è®€å–ã€‚æœ€å°å¿…é ˆè¦æ˜¯ 4 bytesï¼Œæœ€å¤§å‰‡æ˜¯ 255 bytes
- **Message Authentication Code (MAC)** - åŒ…å«ç”¨ä¾†é©—è­‰çš„æ¼”ç®—æ³•ï¼Œæª¢é©—å°åŒ…æ˜¯å¦è¢«ç«„æ”¹

é™¤äº† message authentication code ä¹‹å¤–ï¼Œå…¶é¤˜çš„è³‡æ–™éƒ½æœƒè¢« shared secret åŠ å¯†ã€‚

äº†è§£ SSH æ˜¯å¦‚ä½•é‹ä½œä¹‹å¾Œï¼Œæ¥è‘—å°±ä¾†çœ‹çœ‹å¦‚ä½•æ›´å¿«é€Ÿä¸”æ›´å®‰å…¨åœ°èˆ‡æ©Ÿå™¨é€£ç·šï¼

## ä¿®æ”¹é è¨­çš„ Portï¼Œé¿å…æ©Ÿå™¨è¢«ç˜‹ç‹‚å˜—è©¦ç™»å…¥


é€šå¸¸é è¨­çš„ SSH é€£ç·š Port æœƒæ˜¯ 22ï¼Œå¦‚æœæ©Ÿå™¨è¢«æƒåˆ°å°±æœƒè¢«è¸¹çˆ›ï¼

<CustomImage src='/images/newbie-ssh/door-breaking-port-22.jpg' width={600} height={637} alt='Port 22 door breaking' caption='çŸ­çŸ­å¹¾åˆ†é˜å…§å°±è¢«è¸¹äº†å››åƒå¤šæ¬¡'/>

å› æ­¤æˆ‘å€‘éœ€è¦æŠŠé è¨­çš„ Port æ›æ‰ï¼é€™è£¡æœƒä»‹ç´¹å…©ç¨®æ–¹æ³•ï¼Œåˆ†åˆ¥æ˜¯ä½¿ç”¨ iptables åŠ firewalld ä¾†è¨­å®šã€‚

### iptables

iptables æ˜¯ Linux ç³»çµ±ä¸­ç”¨ä¾†ç®¡ç†é˜²ç«ç‰†åŠå°åŒ…éæ¿¾çš„æŒ‡ä»¤å·¥å…·ã€‚é€éä¸åŒçš„ chain ä¾†é€²è¡Œç®¡ç†é€²å‡ºçš„ trafficã€‚

1. ç·¨è¼¯ä½æ–¼ `/etc/ssh` çš„ `sshd_config` æª”æ¡ˆ

```shell
sudo vim /etc/ssh/sshd_config
```

2. æ‰¾åˆ°ä¸€è¡Œå¯«è‘— `Port 22`ï¼ˆå¯ä»¥æŒ‰ä¸‹ `/` ä¸¦è¼¸å…¥ `22` ä¾†å°‹æ‰¾ï¼‰ï¼Œä¸¦å°‡ Port æ”¹æˆå…¶ä»– Portï¼Œä¾‹å¦‚æ”¹æˆ 20388

```shell
Port 20388
```

3. å„²å­˜ä¸¦é›¢é–‹æª”æ¡ˆ
4. ä½¿ç”¨ `systemctl` æŒ‡ä»¤é‡æ–°å•Ÿå‹• sshd æœå‹™ï¼Œä¸¦é–‹å§‹ç›£è½æ–°çš„ Portã€‚

```shell
sudo systemctl restart sshd
```

Systemd ä½¿ç”¨ `systemctl` é€™å€‹æŒ‡ä»¤ä¾†ç®¡ç†å„ç¨®ç³»çµ±æœå‹™ã€‚åœ¨é€™é‚Šï¼Œæˆ‘å€‘ç”¨ä¾†é‡å•Ÿï¼ˆ`restart`ï¼‰sshd é€™å€‹æœå‹™ã€‚

<Admonition title="Note" types="info">
sshd æ˜¯ OpenSSH daemonï¼ŒæœƒæŒçºŒè½å–ä¾†è‡ª client çš„ SSH é€£ç·šï¼Œä¸¦åšå‡ºç›¸å°æ‡‰çš„è™•ç†ã€‚å¦å¤–å¯ä»¥å°æœå‹™é€²è¡Œçš„æ“ä½œé‚„æœ‰åœæ­¢ï¼ˆ`stop`ï¼‰ã€å•Ÿå‹•ï¼ˆ`start`ï¼‰ã€æª¢æŸ¥ç‹€æ…‹ï¼ˆ`status`ï¼‰ç­‰ç­‰ã€‚`sudo systemctl restart sshd` é€™å€‹æŒ‡ä»¤ç­‰åŒæ–¼ `sudo systemctl restart sshd.service`ï¼Œçœç•¥äº†å¾Œé¢çš„ `.service`ã€‚
</Admonition>

5. æ–°å¢ä¸€æ¢è¦å‰‡ï¼Œè®“å‰›å‰›èª¿æ•´éçš„ Port å¯ä»¥é€šéé˜²ç«ç‰†

```shell
sudo iptables -A INPUT -p tcp --dport 20388 -j ACCEPT
```

`-A INPUT` æ˜¯æŒ‡æˆ‘å€‘æƒ³è¦ append ä¸€å€‹æ–°çš„è¦å‰‡åˆ° `INPUT` Chain ç•¶ä¸­ã€‚å¦å¤–é‚„æœ‰ `FORWARD` åŠ `OUTPUT` chainã€‚

é€™äº› chain ç”¨ä¾†ç®¡ç†é€£ç·šçš„é€²å‡ºï¼Œä¾‹å¦‚ `INPUT` chain ç®¡ç†æ‰€æœ‰é€²åˆ° server çš„å°åŒ…ï¼Œ`OUTPUT` chain ç®¡ç†æ‰€æœ‰ç”±é›¢é–‹ç³»çµ±çš„å°åŒ…ï¼Œ`FORWARD` chain å‰‡ç®¡ç†æ‰€æœ‰ã€Œè·¯éã€ç³»çµ±çš„å°åŒ…ï¼ŒæŒ‡é‚£äº›æœ€çµ‚ç›®çš„åœ°ä¸æ˜¯è©²ç³»çµ±ï¼Œåªæ˜¯é€éç³»çµ±ä¾† routing çš„å°åŒ…å€‘ã€‚é€™ä¸‰å€‹ chain åˆç¨±ç‚º filter tableã€‚åœ¨ iptables ç•¶ä¸­çš„è¦å‰‡æœƒç”±ä¸Šè‡³ä¸‹çš„é€ä¸€æ¯”å°ï¼Œç•¶æ¢ä»¶ç¬¦åˆæ™‚ï¼Œå°±ç”¨è©²è¦å‰‡ä¾†è™•ç†å°åŒ…ï¼Œä¸¦ä¸”ä¸æœƒå†å¾€ä¸‹ç¹¼çºŒæ¯”å°ã€‚

`-p tcp` æŒ‡çš„æ˜¯å°‡é€™å€‹è¦å‰‡å¥—ç”¨åœ¨é€é tcp çš„é€£ç·šä¸Šã€‚`--dport` å®šç¾©ç›®çš„åœ°çš„ portï¼Œå¯ä»¥æ˜¯å–®ä¸€å€‹ portï¼Œåƒæˆ‘å€‘å¯«çš„ `20388`ï¼Œæˆ–æ˜¯ä¸€å€‹ port çš„é–‹å§‹åˆ°çµæŸç¯„åœï¼Œå¦‚ `20388:20340`ã€‚

`-j` ç”¨ä¾†å®šç¾©é€™äº›å°åŒ…æœ€å¾Œè©²ã€Œè·³ï¼ˆjumpï¼‰ã€åˆ°å“ªè£¡ã€‚iptables é è¨­å¯å…è¨±å››ç¨®ç›®æ¨™ï¼š

- `ACCEPT` - æ¥æ”¶å°åŒ…ï¼Œä¸¦åœåœ¨é€™è£¡ï¼Œä¸ç¹¼çºŒå¾€ä¸‹æ¯”å°å…¶ä»– chain çš„è¦å‰‡ã€‚
- `REJECT` - æ‹’çµ•å°åŒ…å‚³éï¼Œä¸¦è·Ÿå‚³é€å°åŒ…çš„å‚¢ä¼™èªªï¼šã€Œæˆ‘ reject äº†å•¦å“ˆå“ˆã€ä¸¦åœåœ¨é€™è£¡ï¼Œä¸ç¹¼çºŒå¾€ä¸‹æ¯”å°å…¶ä»– chain çš„è¦å‰‡ã€‚
- `DROP` - ä»€éº¼éƒ½ä¸åšï¼Œç„¡è²ç„¡æ¯çš„å¿½ç•¥é€™å€‹å°åŒ…ï¼Œä¸¦åœåœ¨é€™è£¡ï¼Œä¸ç¹¼çºŒå¾€ä¸‹æ¯”å°å…¶ä»– chain çš„è¦å‰‡ã€‚
- `LOG` - Log é€™å€‹å°åŒ…ï¼Œä¸¦å¾€ä¸‹ç¹¼çºŒæ¯”å°è¦å‰‡ã€‚

6. æœ€å¾Œï¼Œç”¨ `Drop` ä¾†å¿½ç•¥ Port 22 çš„é€£ç·š

```shell
sudo iptables -A INPUT -p tcp --dport 22 -j DROP
```

å¦‚æ­¤ä¸€ä¾†è¨­å®šå°±å®Œæˆäº†ï¼å¦‚æœç”¨åŸå…ˆé è¨­çš„ Port 22 ä¾†é€£ç·šï¼Œæœ€å¾Œæ‡‰è©²æœƒç­‰åˆ° Connection time out çš„éŒ¯èª¤è¨Šæ¯ã€‚

### firewalld

[firewalld](https://firewalld.org/) é€éã€ŒZoneã€ä¾†å®šç¾©ä¸åŒä¿¡ä»»å±¤ç´šï¼Œä¸¦é€éç­–ç•¥ï¼ˆPolicyï¼‰ä¾†ç®¡ç†åŠéæ¿¾ zone èˆ‡ zone ä¹‹é–“çš„ trafficã€‚

Firewalld å°‡è¨­å®šå€åˆ†ç‚º _Runtime Configuration_ åŠ _Permanent Configuration_ï¼Œå‰è€…åªåœ¨ç•¶ä¸‹çš„ session ç”Ÿæ•ˆï¼Œæ‰€ä»¥åœ¨é‡å•Ÿæˆ–é‡æ–°è¼‰å…¥å¾Œå°±æœƒæ¶ˆå¤±ï¼›å¾Œè€…å‰‡æ˜¯ç•¶ä¸‹ä¸æœƒç”Ÿæ•ˆï¼Œä½†é‡å•Ÿæˆ–é‡æ–°è¼‰å…¥å¾Œæœƒæ°¸ä¹…ç”Ÿæ•ˆã€‚

<CustomImage src='/images/newbie-ssh/firewalld-zone.png' width={600} height={338} alt='Firewalld Zones' caption='Firewalld ã‚¾ãƒ¼ãƒ³ï¼'/>

åœ¨å®‰è£å®Œ firewalld å¾Œï¼Œé è¨­æœƒæœ‰ä¹å€‹ zonesï¼Œåˆ†åˆ¥æ˜¯ `drop`ã€`public`ã€`trusted`ã€`block`ã€`dmz`ã€`external`ã€`home`ã€`internal` åŠ `work`ã€‚

æ¯å€‹ zone éƒ½æœ‰ä¸åŒçš„è¨­å®šåŠä¿¡ä»»å±¤ç´šã€‚èˆ‰ä¾‹ä¾†èªªï¼Œ`drop` æœƒ drop æ‰€æœ‰é€²ä¾†çš„é€£ç·šï¼Œåªå…è¨±å‡ºå»çš„é€£ç·šï¼›`public` å‰‡æ˜¯é è¨­çš„ zoneï¼Œæœƒå…è¨±ä¸€äº›å¸¸è¦‹çš„æœå‹™ï¼Œä¾‹å¦‚ httpã€httpsã€ssh ç­‰ç­‰ï¼Œ`trusted` å‰‡æœƒå…è¨±æ‰€æœ‰çš„é€£ç·šã€‚

è€Œå¦‚æœæœ‰å®‰è£ [Docker](https://www.docker.com/)ï¼Œå‰‡æœƒè‡ªå‹•å¤šå‡ºä¸€å€‹ `docker` zoneï¼Œå°‡ Docker ç”¢ç”Ÿçš„æ‰€æœ‰ network interfaces æ”¾å…¥ `docker` zone ç•¶ä¸­ã€‚ 

æ¥è‘—ä¾†çœ‹æ€éº¼ä½¿ç”¨ firewalld ä¾†è¨­å®š Port å§ï¼

### firewalld è¨­å®š Port

1. å…è¨± 20388 é€é tcp çš„é€£ç·šï¼Œæ²’æœ‰å¸¶å…¥ `zone` option å‰‡é è¨­ç‚º public zone

```shell
sudo firewall-cmd --add-port=20388/tcp --permanent
```

`--permanent` flag å°‡è©²è¨­å®šæ¨™è¨˜ç‚ºæ°¸ä¹…å­˜åœ¨çš„è¨­å®šï¼Œå› æ­¤è¦é‡æ–°è¼‰å…¥å¾Œæ‰æœƒç”Ÿæ•ˆã€‚å¦‚æœæ²’æœ‰ `--permanent` flagï¼Œå‰‡é è¨­æœƒæ˜¯ runtime configã€‚

2. é‡æ–°è¼‰å…¥ firewalld daemon

```shell
sudo firewall-cmd --reload
```

3. æª¢æŸ¥ port æ˜¯å¦è¨­å®šæ­£ç¢º

```shell
sudo firewall-cmd --list-all
```

æ­¤æ™‚æ²’æ„å¤–çš„è©±ï¼Œå°±å¯ä»¥çœ‹åˆ° port è¨­å®šå¥½äº†ï¼

```shell
public
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: ...
  ports: 20388/tcp
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

4. ç·¨è¼¯ä½æ–¼ `/etc/ssh` çš„ `sshd_config` æª”æ¡ˆ

```shell
sudo vim /etc/ssh/sshd_config
```

5. æ‰¾åˆ°ä¸€è¡Œå¯«è‘— `Port 22`ï¼ˆå¯ä»¥æŒ‰ä¸‹ `/` ä¸¦è¼¸å…¥ `22` ä¾†å°‹æ‰¾ï¼‰ï¼Œä¸¦å°‡ Port æ”¹æˆ 20388

```shell
Port 20388
```

å¦‚æœæƒ³è¦æ”¯æ´å¤šå€‹ Portï¼Œå¯ä»¥åœ¨ä¸‹é¢ç¹¼çºŒåŠ ä¸Šå»ï¼Œä¾‹å¦‚ï¼š

```shell
Port 20388
Port 20400
```

è¨˜å¾—è¦é‡è¤‡ä¸€æ¬¡ firewalld çš„è¨­å®šã€‚

## å¦‚ä½•ä¸ç”¨è¼¸å…¥å¯†ç¢¼åŠ IP é€²å…¥æ©Ÿå™¨

å®Œæˆ Port çš„è¨­å®šä¹‹å¾Œï¼Œæ¥è‘—å°±å¯ä»¥æ‹¿è‘—ç†±é¨°é¨°çš„ Port ä¾†å¿«é€Ÿé€²å…¥æ©Ÿå™¨ï¼

1. å»ºç«‹ public-private key pairsï¼Œä¸¦æŒ‡å®šæª”æ¡ˆåç¨±åŠè·¯å¾‘ã€‚`-t` åƒæ•¸ç”¨ä¾†æŒ‡å®šä½¿ç”¨ä½•ç¨®æ¼”ç®—æ³•ä¾†ç”¢ç”Ÿ keysã€‚é€™è£¡æˆ‘å€‘æŠŠå®ƒå«åš `id_rsa_remote_vps`

```shell
ssh-keygen -t rsa
```

æˆ–æ˜¯ç”¨ key size æ›´å°ã€æ›´å®‰å…¨çš„ ed25519 æ¼”ç®—æ³•

```shell 
ssh-keygen -t ed25519
```

<CustomImage src='/images/newbie-ssh/ssh-keygen.png' width={762} height={674} alt='ssh-keygen'/>

2. æ¥è‘—åˆ° `/User/username/.ssh` é€™å€‹è·¯å¾‘åº•ä¸‹ï¼Œå°±æœƒçœ‹åˆ°å‰›æ‰ç”¢ç”Ÿçš„å…©å€‹ key æª”æ¡ˆï¼Œåˆ†åˆ¥æ˜¯ `id_rsa_remote_vps` åŠ `id_rsa_remote_vps.pub`
3. å°‡æ–°é®®å‡ºçˆçš„ public key ä¸Ÿåˆ° remote server ä¸Šã€‚å¯ä»¥æ‰‹å‹•å°‡ `id_rsa_remote_vps.pub` è£¡é¢çš„å…§å®¹è²¼åˆ° remote server è£¡é¢çš„ `~/.ssh/authorized_keys` é€™å€‹æª”æ¡ˆç•¶ä¸­ï¼Œæˆ–è€…æ˜¯ä½¿ç”¨æŒ‡ä»¤ã€‚`-i` å¾Œé¢æŒ‡å‘å‰›æ‰ç”¢ç”Ÿçš„ public key ä½ç½®

```shell
ssh-copy-id -i ~/.ssh/id_rsa_remote_vps.pub root@your-remote-server-ip
```

æ­¤æ™‚é€²åˆ° remote server ç•¶ä¸­ï¼Œå°±å¯ä»¥åœ¨ `~/.ssh/` åº•ä¸‹çœ‹åˆ° `authorized_keys` é€™å€‹æª”æ¡ˆ

<CustomImage src='/images/newbie-ssh/authorized-keys.png' width={1118} height={560} alt='authorized-keys'/>

4. æ¥è‘—è¦ä¾†è¨­å®šæœ¬æ©Ÿã€‚åœ¨æœ¬æ©Ÿçš„ `~/.ssh/` è³‡æ–™å¤¾åº•ä¸‹æ–°å¢ä¸€å€‹æª”æ¡ˆï¼Œåç¨±å«åš `config`ã€‚å¦‚æœæ²’æœ‰çš„è©±ï¼Œå¯ä»¥ç”¨ `touch` ä¾†æ–°å¢

```shell
touch ~/.ssh/config
```

5. ç·¨è¼¯å‰›æ‰æ–°å¢çš„ `config`ï¼Œå¡«å…¥ remote server IP addressã€Userã€å‰›æ‰è¨­å®šçš„ Portï¼Œä¸¦å°‡å‰›æ‰æ–°å¢çš„ SSH private key è·¯å¾‘æ”¾åœ¨ `IdentityFile`ï¼Œæœ€å¾Œåœ¨ `Host` å¡«ä¸Šæƒ³è¦ç”¨ä¾†é€£æ¥çš„åç¨±

```shell
# ~/.ssh/config
Host remote-vps
	HostName your-remote-ip
	User someuser
	IdentityFile ~/.ssh/id_rsa_remote_vps
	Port 20388
```

6. æœ€å¾Œï¼Œå°±å¯ä»¥ç›´æ¥ç”¨åç¨±ï¼Œé€é SSH é€£ç·šè‡³ remote server ğŸ¥³

```shell
ssh remote-vps
```

## ç¸½çµ

æˆ‘å€‘ä¸€è·¯å¾ SSH å¦‚ä½•é€£ç·šï¼Œèªªåˆ°å¦‚ä½•ä¿®æ”¹ Portï¼Œæœ€å¾Œäº†è§£å¦‚ä½•ä¸ç”¨è¼¸å…¥å¯†ç¢¼åŠ IP ä¾†é€£ç·šè‡³ remote serverã€‚ä»¥å¾Œçµ‚æ–¼å¯ä»¥ç†ç›´æ°£å£¯åœ°èªªå‡º **SSH** ä¸‰å€‹å­—äº†ï¼

<Callout>
\ SSH! / \ SSH! / \ SSH! /
</Callout>

## Reference

- [RFC4252 - The Secure Shell (SSH) Authentication Protocol](https://www.rfc-editor.org/rfc/rfc4252.txt)
- [RFC4253 - The Secure Shell (SSH) Transport Layer Protocol](https://datatracker.ietf.org/doc/html/rfc4253)
- [How to SSH Without a Password (like a boss)](https://www.youtube.com/watch?v=j2vBT3T79Pg)
- [Linux systemd ç³»çµ±æœå‹™ç®¡ç†åŸºç¤æ•™å­¸èˆ‡ç¯„ä¾‹](https://blog.gtwang.org/linux/linux-basic-systemctl-systemd-service-unit-tutorial-examples/ "Linux systemd ç³»çµ±æœå‹™ç®¡ç†åŸºç¤æ•™å­¸èˆ‡ç¯„ä¾‹")
- [IptablesHowTo](https://help.ubuntu.com/community/IptablesHowTo)
- [CentOS Linux 7 ä»¥ firewalld æŒ‡ä»¤è¨­å®šé˜²ç«ç‰†è¦å‰‡æ•™å­¸](https://blog.gtwang.org/linux/centos-7-firewalld-command-setup-tutorial/ "CentOS Linux 7 ä»¥ firewalld æŒ‡ä»¤è¨­å®šé˜²ç«ç‰†è¦å‰‡æ•™å­¸")
- [Integration with Firewalld](https://docs.docker.com/network/packet-filtering-firewalls/#integration-with-firewalld)
- [Three-Way Handshake - Computer Networks](https://www.sciencedirect.com/book/9780128182000/computer-networks)