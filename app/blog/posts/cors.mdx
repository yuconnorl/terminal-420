---
title: Cross-Origin Resource Sharing (CORS)
description: ç³Ÿäº†ï¼Œæ˜¯ CORSï¼
id: 8bd5ae80-7109-405d-ae72-df83556e2e26
publishedAt: 2023-Oct-09 14:53:21+08:00
category: frontend
---

<CustomImage src='/images/cors/doraemon-cors-help-me.jpg' width={600} height={437} alt='Doraemon tasukete' caption='å¾Œç«¯ A å¤¢æ•‘æ•‘æˆ‘å—šå—šå—š'/>

> é‡åˆ° CORS æ€éº¼è¾¦ ğŸ˜«

> æ‰¾å¾Œç«¯ (âŒ)

åˆç¨±è·¨ä¾†æºè³‡æºå…±ç”¨ï¼Œç•¶æˆ‘å€‘ä½¿ç”¨ JavaScript å–å¾—è³‡æºæ™‚ï¼ŒéåŒæºçš„ request æœƒå› ç‚ºå®‰å…¨æ€§è€ƒé‡è€Œå—åˆ°é™åˆ¶ã€‚ç€è¦½å™¨æœƒå¼·åˆ¶ä½ éµå®ˆ CORS çš„è¦ç¯„ï¼Œå¦å‰‡ request æœƒå¤±æ•ˆã€‚

## ä»€éº¼æ˜¯åŒæº?

ä¾æ“š [åŒæºæ”¿ç­–](https://developer.mozilla.org/zh-TW/docs/Web/Security/Same-origin_policy)ï¼ˆSame-origin policyï¼‰ï¼Œå…©å€‹ç¶²é å…·å‚™ç›¸åŒå”å®šï¼ˆprotocolï¼‰ã€åŸ è™Ÿï¼ˆportï¼Œå¦‚æœæœ‰æŒ‡å®šï¼‰ä»¥åŠç¶²åŸŸï¼ˆdomainï¼‰ï¼Œå‰‡ç‚ºåŒæºã€‚è€ŒéåŒæºçš„ç¶²ç«™ç”¢ç”Ÿçš„ request å³ç‚ºè·¨ä¾†æºè«‹æ±‚ï¼ˆcross-origin http requestï¼‰ã€‚ä»¥ `https://www.terminal-420.space` ä¾†å’Œä¸‹é¢å¹¾å€‹ç¶²å€ç›¸æ¯”ï¼š

```markdown

1. http://www.terminal-420.space // é€šè¨Šå”å®šä¸åŒï¼ŒéåŒæº
2. https://www.terminal-420.com // domain ä¸åŒï¼ŒéåŒæº
3. https://www.cannabis.terminal-420.space // domain ä¸åŒï¼ŒéåŒæº
4. https://www.terminal-420.space:3080 // åŸ è™Ÿä¸åŒï¼ŒéåŒæº
5. https://www.terminal-420.space/blog // åŒæº

```

è€Œä¾†è‡ªæ–¼éåŒæºçš„è«‹æ±‚ï¼Œå°±ç¨±ç‚º**è·¨ä¾†æºè«‹æ±‚**ã€‚

## ä»€éº¼æ˜¯ CORSï¼Ÿ

CORS æ˜¯ä¸€ç¨®æ©Ÿåˆ¶ï¼Œå…¶ä½¿ç”¨é¡å¤–çš„ Http headerï¼Œè®“éåŒæºçš„è«‹æ±‚å¯ä»¥è¢«ç®¡ç†ã€ä¸¦å®‰å…¨çš„å›è¦†è©²è«‹æ±‚ã€‚

åœ¨ JavaScript ä¸­ï¼Œå¦‚æœåœ¨ Server æ²’æœ‰é¡å¤–è¨­å®šçš„æƒ…æ³ä¸‹ï¼Œæ‰€æœ‰éåŒæºè«‹æ±‚éƒ½æœƒè¢«é˜»æ“‹ã€‚è€Œåœ¨ CORS çš„è¦ç¯„ä¸­ï¼Œè·¨ä¾†æºè«‹æ±‚åˆ†ç‚ºå…©ç¨®ï¼Œç°¡å–®ï¼ˆsimpleï¼‰å’Œé æª¢ï¼ˆpreflightedï¼‰è«‹æ±‚

### ç°¡å–®è«‹æ±‚ï¼ˆSimple requestï¼‰

ä¸éœ€è¦ç¶“é preflightedï¼ˆæˆ–ä¸è§¸ç™¼ preflightedï¼‰å°±å¯ä»¥ç›´æ¥ç™¼é€çš„è«‹æ±‚ï¼Œåœ¨ fetch spec ç•¶ä¸­ç¨±ç‚º `non-preflighted request`ã€‚åƒ…å…è¨±ä¸‹é¢ä¸‰å€‹ HTTP Methods

- GET
- HEAD
- POST

é™¤äº† HTTP Methods ä¹‹å¤–ï¼Œç°¡å–®è«‹æ±‚ä¸­åªèƒ½åŒ…å«ç‰¹å®šçš„ header fieldã€‚é™¤äº† user agent è‡ªå‹•è¨­å®šçš„ headerï¼ˆå¦‚ Connectionã€User-Agentï¼‰ä¹‹å¤–ï¼Œå¦å¤–å¯ä»¥åŠ ä¸Šï¼š

- [`Accept`](https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/Accept)
- [`Accept-Language`Â (en-US)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Language "Currently only available in English (US)")
- [`Content-Language`Â (en-US)](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Language "Currently only available in English (US)")
- [`Content-Type`](https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/Content-Type)ï¼ˆä½†è«‹æ³¨æ„ä¸‹æ–¹çš„é¡å¤–è¦æ±‚ï¼‰
- [`Last-Event-ID`](https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/Last-Event-ID "This is a link to an unwritten page")
- [`DPR`](https://httpwg.org/http-extensions/client-hints.html#dpr)
- [`Save-Data`](https://httpwg.org/http-extensions/client-hints.html#save-data)
- [`Viewport-Width`](https://httpwg.org/http-extensions/client-hints.html#viewport-width)
- [`Width`](https://httpwg.org/http-extensions/client-hints.html#width)

å…¶ä¸­ï¼Œ[`Content-Type`](https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/Content-Type) åªèƒ½åŒ…å« `application/x-www-form-urlencoded`ã€`multipart/form-data`ã€`text/plain` é€™ä¸‰ç¨®ã€‚å› æ­¤ä¸‹æ–¹çš„è«‹æ±‚å°±ä¸ç¬¦åˆç°¡å–®è«‹æ±‚çš„æ¨™æº–ï¼Œå› çˆ² `Content-Type` ç‚º `application/json`

```javascript
const response = await fetch('https://othersite.com/data', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  }
});
```

å¦‚æœè©²è«‹æ±‚ç¬¦åˆç°¡å–®è«‹æ±‚çš„æ‰€æœ‰è¦ç¯„ï¼Œé‚£éº¼ç€è¦½å™¨æœƒå‘ Server ç™¼é€ requestã€‚å¦‚æœæˆ‘å€‘åœ¨ `https://www.terminal-420.space` å‘å¦ä¸€å€‹ Server ç™¼é€ä¸€å€‹ requestï¼Œå¤§æ¦‚æœƒé•·çš„åƒé€™æ¨£ï¼š

```http
GET /resources/public-data/ HTTP/1.1
Host: someserver.com
User-Agent: ...
Accept: ...
Accept-Language: ...
Accept-Encoding: ...
Accept-Charset: ...
Connection: ...
Referer: ...
Origin: https://www.terminal-420.space
```

åœ¨æœ€å¾Œçš„ `Origin` header ç•¶ä¸­ï¼Œæ¨™ç¤ºäº†é€™å€‹ request å¾ä½•è€Œä¾†ã€‚é€™å€‹æƒ…å¢ƒä¸‹æ˜¯ `https://www.terminal-420.space` ç™¼å‡ºè«‹æ±‚ã€‚å†ä¾†çœ‹çœ‹ä¼ºæœå™¨å¦‚ä½•å›æ‡‰é€™å€‹è«‹æ±‚

```http
HTTP/1.1 200 OK
Date: ...
Server: ...
Access-Control-Allow-Origin: *
Keep-Alive: ...
Connection: ...
Transfer-Encoding: ...
Content-Type: application/xml
```

åœ¨ Server å›å‚³çš„ header ç•¶ä¸­æœ‰ä¸€å€‹ `Access-Control-Allow-Origin`ï¼Œå…¶å€¼ç‚º `*`ï¼Œä»£è¡¨ä»–å¯ä»¥å…è¨±ä»»ä½•ç¶²ç«™è·¨ç«™è«‹æ±‚è³‡æºã€‚å¦‚æœä¼ºæœå™¨åƒ…å…è¨±ç‰¹å®šä¾†æºï¼Œåƒæ˜¯ `https://www.terminal-420.space` æ‰èƒ½å¤ å­˜å–çš„è©±ï¼Œé‚£éº¼ `Access-Control-Allow-Origin` é€™å€‹ header å‰‡æœƒå›å‚³ï¼š

```http
Access-Control-Allow-Origin: https://www.terminal-420.space
```

è€Œå…¶ä»–é `https://www.terminal-420.space` çš„ç«™é»éƒ½ç„¡æ³•å­˜å–è©²è³‡æºã€‚

### é æª¢è«‹æ±‚ï¼ˆPreflighted requestï¼‰

å…¶ä»–å„ç¨®éç°¡å–®è«‹æ±‚çš„ requestï¼Œéƒ½å¿…é ˆå…ˆç¶“éã€Œé æª¢ï¼ˆpreflightedï¼‰ã€å¾Œï¼Œæ‰èƒ½ç™¼é€å‡ºå¯¦éš›çš„è«‹æ±‚ã€‚åœ¨è«‹æ±‚ç™¼é€ä¹‹å¾Œï¼Œæœƒå…ˆç¶“é [CORS check](https://fetch.spec.whatwg.org/#concept-cors-check)ã€‚ç•¶æ•¸å€‹æ¢ä»¶éƒ½ç¬¦åˆæ™‚ï¼ˆå…¶ä¸­ä¸€å€‹æ˜¯è¨­ç½® [use-CORS-preflight flag](https://fetch.spec.whatwg.org/#use-cors-preflight-flag) ï¼‰ï¼Œæ­¤æ™‚å°±æœƒç™¼é€é æª¢è«‹æ±‚ï¼ˆCORS-preflight fetchï¼‰

CORS-preflight fetch é€é HTTP OPTIONS æ–¹æ³•ä¾†ç™¼é€ï¼Œç”¨ä¾†ç¢ºèªä¼ºæœå™¨å¯ä¸å¯ä»¥æ¥æ”¶é€™å€‹è«‹æ±‚ã€‚ä¸€å€‹ Preflighted request å¤§æ¦‚é•·å¾—åƒé€™æ¨£

```http
OPTIONS /resources/post-here/ HTTP/1.1
Host: bar.example
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
Origin: https://foo.example
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER, Content-Type
```

å…¶ä¸­æœ€ä¸‹æ–¹çš„ `Access-Control-Request-Method` åŠ `Access-Control-Request-Headers` åˆ†åˆ¥åŒ…å«äº†çœŸæ­£è¦è«‹æ±‚çš„æ–¹æ³•ä»¥åŠ headersã€‚åœ¨é€™è£¡ï¼Œæˆ‘å€‘çœŸæ­£æƒ³è¦ç™¼é€çš„è«‹æ±‚æ˜¯ POSTï¼Œå…¶ä¸­åŒ…å«äº† `X-PINGOTHER` ä»¥åŠ `Content-Type` é€™å…©å€‹ headersã€‚

å¦‚æœé€™äº›éƒ½ç¬¦åˆ Server çš„è¨­å®šï¼ŒServer å°±æœƒå›å‚³ `200` OK çš„ response

```http
HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 01:15:39 GMT
Server: Apache/2.0.61 (Unix)
Access-Control-Allow-Origin: https://foo.example
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
Access-Control-Max-Age: 86400
Vary: Accept-Encoding, Origin
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
```

å…¶ä¸­åŒ…å«

- `Access-Control-Allow-Origin`ï¼šServer å…è¨±é€²è¡Œ CORS è«‹æ±‚çš„ Origins
- `Access-Control-Allow-Methods`ï¼šServer å…è¨±çš„è«‹æ±‚æ–¹æ³•ï¼Œåœ¨é€™è£¡åŒ…å« `POST` `GET` åŠ `OPTIONS`
- `Access-Control-Allow-Headers`ï¼šServer å…è¨±çš„ Headers
- `Access-Control-Max-Age`ï¼šé€™å€‹ permissions è¢«å¿«å–çš„æ™‚é–“ï¼Œé€™è£¡æ˜¯ 86400 ç§’ï¼Œä¹Ÿå°±æ˜¯ä¸€å¤©æ•´

è€Œä¾æ“š [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/OPTIONS#status_code)ï¼ŒStatus code `200` å’Œ `204` No Content éƒ½æ˜¯å…è¨±çš„ status codeï¼Œä½†æœ‰äº›ç€è¦½å™¨ä¼¼ä¹æœƒå› ç‚º status `204` è€Œä¸æ¥è‘—ç™¼é€å¾ŒçºŒçš„ requestã€‚

## Request with credentials

åœ¨é è¨­æƒ…æ³ä¸‹ï¼Œè·¨åŸŸçš„ `Fetch` æˆ– `XMLHttpRequest` éƒ½ä¸æœƒå¸¶æœ‰ cookieï¼Œé™¤éåœ¨ request ä¸­å¸¶å…¥ç‰¹å®šçš„ flagã€‚åœ¨ `Fetch` ä¸­éœ€å°‡ `credentials` è¨­ç½®ç‚º `include`

```javascript
fetch('https://someserver.com/resources/public-data/', {
  credentials: 'include'
})
```

è€Œ `XMLHttpRequest` å‰‡éœ€å¸¶å…¥ `withCredentials = true`

```javascript
const invocation = new XMLHttpRequest();
const url = "https://bar.other/resources/credentialed-content/";

function callOtherDomain() {
  if (invocation) {
    invocation.open("GET", url, true);
    invocation.withCredentials = true;
    invocation.onreadystatechange = handler;
    invocation.send();
  }
}
```

å¦å¤–ï¼Œç„¡è«–æ˜¯ç°¡å–®è«‹æ±‚æˆ–éœ€è¦é æª¢çš„è«‹æ±‚ï¼Œè‹¥ Server æ²’æœ‰åœ¨ response ä¸­å¸¶å…¥ `Access-Control-Allow-Credentials: true` çš„è©±ï¼Œé‚£éº¼ç€è¦½å™¨ç«¯é‚„æ˜¯ç„¡æ³•çœ‹åˆ°å›å‚³çš„è³‡è¨Šã€‚

## CORS-preflight cache

CORS-preflight cache æ˜¯ä¸€ä¸² listï¼Œè£¡é¢æ”¾è‘— cache çš„å¯¦é«”ã€‚æ¯ä¸€å€‹ CORS-preflight cache å¯¦é«”åŒ…å«ï¼š

- keyÂ (aÂ [network partition key](https://fetch.spec.whatwg.org/#network-partition-key))
- byte-serialized originÂ (aÂ [byte sequence](https://infra.spec.whatwg.org/#byte-sequence))
- URLÂ (aÂ [URL](https://url.spec.whatwg.org/#concept-url))
- max-ageÂ (a number of seconds)
- credentialsÂ (a boolean)
- methodÂ (null, `*`, or aÂ [method](https://fetch.spec.whatwg.org/#concept-method))
- header nameÂ (null, `*`, or aÂ [header name](https://fetch.spec.whatwg.org/#header-name))

ç•¶ cache å¯¦é«”å»ºç«‹å®Œæˆå¾Œï¼Œå°±æœƒåŠ å…¥åˆ° user agent çš„ CORS-preflight cache ç•¶ä¸­ã€‚

è‹¥è¦ç§»é™¤ cacheï¼Œæœƒæ¯”å° keyã€[byte-serialized origin](https://fetch.spec.whatwg.org/#concept-cache-origin) ä»¥åŠ URLï¼Œæ‰¾åˆ°æ­£ç¢ºçš„ cache å¾Œç§»é™¤ã€‚

## Express çš„ CORS åšäº†ä»€éº¼

çµ‚æ–¼ææ‡‚ CORS ä¹‹å¾Œï¼Œä¾†çœ‹çœ‹ Express çš„ CORS åšäº†ä»€éº¼ï¼[cors](https://github.com/expressjs/cors) æ˜¯ express çš„ä¸€å€‹ middleware packageï¼Œç”¨ä¾†è¨­ç½® CORS çš„åƒæ•¸ã€‚

æ‰“é–‹ cors çš„ [source code](https://github.com/expressjs/cors/blob/master/lib/index.js) ä¸€çœ‹ï¼Œå…¶å¯¦ä¹Ÿæ‰å…©ç™¾å¤šè¡Œï¼Œè€Œä¸”æ¯ä¸€å€‹ function åšçš„äº‹éƒ½é‚„è »æ¸…æ¥šçš„ã€‚ä¸åŒ function ç”¨ä¾†è¨­ç½®ä¸åŒçš„ headerï¼Œä¸¦ä»¥é™£åˆ—å½¢å¼å„²å­˜ï¼Œæœ€å¾Œç”¨ `join` å°‡é™£åˆ—ä¸­çš„å€¼çµ„åˆèµ·ä¾†ï¼Œæˆ–æ˜¯å›å‚³é™£åˆ—ç¹¼çºŒçµ„åˆã€‚

åƒæ˜¯è¨­ç½® Method çš„ `configureMethods`ï¼š

```javascript
function configureMethods(options) {
  var methods = options.methods;
  if (methods.join) {
    methods = options.methods.join(','); // .methods is an array, so turn it into a string
  }
  return {
    key: 'Access-Control-Allow-Methods',
    value: methods
  };
}
```

åœ¨ express è£¡é¢å¯«çš„é€™äº›è¨­å®šï¼Œå¥½åƒä¹Ÿå°±å¾ˆå¥½ç†è§£äº†ï¼

```javascript
const express = require('express')
const app = express()
const cors = require('cors')

app.use(cors({
	origin: "http://127.0.0.1:5500",
	methods: ["GET", "POST"],
	credentials: true
}))
```

## å­˜å–ç§æœ‰ç¶²è·¯ - RFC1918 CORS

ç‚ºäº†é˜²æ­¢ cross-site request forgery (CSRF) é€éå®¶ä¸­çš„ router åˆ°é”ç§æœ‰æˆ–å€åŸŸç¶²è·¯ä¸­çš„å…¶ä»–è¨­å‚™ï¼ŒGoogle æå‡º [CORS for private networks (RFC1918)](https://developer.chrome.com/articles/cors-rfc1918-feedback/#chrome%27s-plans-to-enable-cors-rfc1918)ã€‚å…¶æœ€ä¸»è¦çš„æ›´å‹•æ˜¯åœ¨ Chrome 94 ç‰ˆä¹‹å¾Œï¼Œç„¡æ³•å¾ä¸å®‰å…¨çš„ç¶²ç«™ï¼ˆhttp å°±æ˜¯åœ¨èªªä½ ï¼‰ç™¼é€ request çµ¦ç§æœ‰ç¶²è·¯ã€‚

è€Œå—åˆ°å½±éŸ¿çš„å­˜å–æœƒæœ‰ï¼š

- å…¬é–‹ç¶²è·¯å°ç§æœ‰ç¶²è·¯çš„å­˜å–ï¼ˆRequests from the public network to a private networkï¼‰
- å…¬é–‹ç¶²è·¯å°å€åŸŸç¶²è·¯çš„å­˜å–ï¼ˆRequests from the public network to a local networkï¼‰
- ç§æœ‰ç¶²è·¯å°å€åŸŸç¶²è·¯çš„å­˜å–ï¼ˆRequests from a private network to a local networkï¼‰

### é‚£...ç§æœ‰ç¶²è·¯å­˜å–æ˜¯ä»€éº¼

> Private network requests are requests whose target server's IP address is more private than that from which the request initiator was fetched. For example, a request from a public website (https://example.com) to a private website (http://router.local), or a request from a private website to localhost.

è¦ææ‡‚ä»€éº¼æ˜¯ç§æœ‰ç¶²è·¯å­˜å–ï¼Œå°±å¿…é ˆå…ˆå®šç¾©ä»€éº¼æ˜¯å€åŸŸã€ç§æœ‰åŠå…¬é–‹ç¶²è·¯ã€‚

å€åŸŸ IP ä½ç½®ï¼ˆLocal IP address spaceï¼‰ä¸­åŒ…å« IPv4 çš„ loopback addresses `127.0.0.0/8` åŠ IPv6 loopback addresses `0:0:0:0:0:0:0:1`ï¼ˆæˆ– `::1/128`ï¼‰ã€‚

ç§æœ‰ IP ä½ç½®ï¼ˆPrivate IP address spaceï¼‰ä¸­åŒ…å«é‚£äº›åƒ…åœ¨è©²ç¶²åŸŸæˆ–ç¶²è·¯å€æ®µæœ‰æ„ç¾©çš„ IP ä½ç½®ï¼Œåƒæ˜¯ router çš„å…§éƒ¨ç¶²è·¯ã€‚ä¾‹å¦‚ `10.0.0.0/8`ã€`172.16.0.0/12` åŠ `192.168.0.0/16`ã€‚

æœ€å¾Œï¼Œåœ¨é€™äº›é¡åˆ¥ä»¥å¤–çš„ç¶²è·¯å‡å±¬æ–¼å…¬é–‹ç¶²è·¯ã€‚

<Admonition
  title="ä»€éº¼æ˜¯ loopback address"
  types="info"
>
Loopback address è®“ä¸€å€‹ç³»çµ±å¯ä»¥å‚³é€è¨Šæ¯çµ¦è‡ªå·±çš„ä¸€æ®µ IP addressï¼Œå¯ç”¨ä¾†ç¢ºèª TCP/IP stack æ˜¯å¦å®‰è£åŠæ­£å¸¸é‹ä½œï¼Œå…¶å¯¦å°±æ˜¯ `localhost`ã€‚IPv4 ä»¥ `127` ä½œç‚ºé–‹é ­çš„ IP address å‡ç‚º loopback addressã€‚
</Admonition>

åœ¨é€™ä¸‰ç¨® IP address ä¹‹ä¸­ï¼Œå€åŸŸç¶²è·¯æœ€ç‚ºç§å¯†ï¼Œæ¥è‘—æ˜¯ç§æœ‰ç¶²è·¯ï¼Œæœ€å¾Œæ˜¯å…¬é–‹ç¶²è·¯ã€‚ä¸‰è€…é–“çš„é—œä¿‚å¦‚ä¸‹åœ–æ‰€ç¤º

<CustomImage src='/images/cors/public-private-local-networks-relationship.jpg' width={1500} height={1125} alt='Relationship between public, private, local networks in Private Network Access (CORS-RFC1918).' caption='å…¬é–‹ã€ç§æœ‰åŠå€åŸŸç¶²è·¯é–“çš„é—œä¿‚ (CORS-RFC1918)'/>

### é€™å’Œ CORS æœ‰ä»€éº¼é—œä¿‚

åœ¨é€™å€‹æ–°æ”¹å‹•ä¸­åŠ å…¥äº†å…©å€‹ preflight headersï¼Œåˆ†åˆ¥æ˜¯ `Access-Control-Request-Private-Network` åŠ `Access-Control-Allow-Private-Network`ã€‚

åœ¨é€™å€‹æ”¹å‹•ä¹‹å¾Œï¼Œä»»ä½•ç™¼é€çµ¦ private network çš„ request éƒ½éœ€è¦å…ˆç™¼é€ preflight requestï¼Œä¸”é€™å€‹ preflight request æœƒå¸¶å…¥ `Access-Control-Request-Private-Network: true` çš„ headerï¼Œç„¡è«–æ˜¯ä½•ç¨®è«‹æ±‚æ–¹æ³•æˆ–[æ¨¡å¼](https://developer.mozilla.org/en-US/docs/Web/API/Request/mode)ã€‚è‹¥æ˜¯ Server å…è¨±é€™å€‹è«‹æ±‚ï¼Œå‰‡éœ€è¦åœ¨ response ä¸­å¸¶å…¥ `Access-Control-Allow-Private-Network: true` çš„ headerã€‚

æ­¤å¤–ï¼Œå¦‚æœè¼ƒä¸ç§å¯†çš„ç¶²è·¯ï¼ˆå¦‚ç§æœ‰ IPï¼‰æƒ³è¦ç™¼é€è«‹æ±‚çµ¦æ›´ç§å¯†çš„ç¶²è·¯ï¼ˆå¦‚å€åŸŸ IPï¼‰ï¼Œé‚£éº¼å³ä¾¿æ˜¯åœ¨ `same-origin` æ¨¡å¼ä¸‹çš„è«‹æ±‚ï¼Œä¹Ÿå¿…é ˆå…ˆç™¼é€ preflight request å¾Œæ‰èƒ½ç™¼é€æ­£å¸¸è«‹æ±‚ã€‚

### ä¾†çœ‹é»å¯¦éš›ç¯„ä¾‹

åœ¨ `https://foo.example/index.html` ä¸­åµŒæœ‰ä¸€å€‹ image tag `<img src="https://bar.example/cat.gif" alt="dancing cat"/>`ï¼Œå…¶åœ–ç‰‡ä½ç½®çš„ domain `bar.example` æœƒè§£æè‡³ `192.168.1.1` é€™å€‹ IP ä½ç½®ï¼Œç‚ºç§æœ‰ç¶²è·¯ä¸­çš„ IPã€‚å› æ­¤ï¼Œé€™å€‹è«‹æ±‚å³ç‚ºã€Œå…¬é–‹ç¶²è·¯ã€ç™¼é€çµ¦ã€Œç§æœ‰ç¶²è·¯ã€çš„è«‹æ±‚ã€‚

æ ¹æ“šä¸Šè¿°æåˆ°çš„æ–°è¦ç¯„ï¼ŒChrome æœƒé€å‡ºé•·é€™æ¨£çš„ preflight requestï¼Œå…¶ä¸­å¸¶æœ‰ `Access-Control-Request-Private-Network: true` é€™å€‹æ–°çš„ headerã€‚

```http
HTTP/1.1 OPTIONS /cat.gif
Origin: https://foo.example
Access-Control-Request-Private-Network: true
```

å¦‚æœè¦è®“é€™å€‹ preflight request èƒ½å¤ æˆåŠŸï¼Œé‚£éº¼ server å¿…é ˆåœ¨ response ä¸­å¸¶å…¥ `Access-Control-Allow-Private-Network: true` headerã€‚

```http
HTTP/1.1 204 No Content
Access-Control-Allow-Origin: https://foo.example
Access-Control-Allow-Private-Network: true
```

æœ€å¾Œåœ¨ preflight request æˆåŠŸå¾Œï¼ŒChrome ä¾¿æœƒæ¥çºŒç™¼é€çœŸæ­£çš„ requestï¼Œå°‡åœ–ç‰‡è³‡æºè«‹æ±‚å›ä¾†ã€‚

```http
HTTP/1.1 GET /cat.gif
...
```

## çµè«–

> é‡åˆ° CORS æ€éº¼è¾¦ ğŸ˜«

> ç†ç›´æ°£å£¯çš„æ‰¾å¾Œç«¯ (âœ…)

## Reference

- [Cross-Origin Resource Sharing (CORS)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#the_http_request_headers)
- [MDN - Preflight request](https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request)
- [Fetch Standard - CORS-preflight cache](https://fetch.spec.whatwg.org/#concept-cache)
- [[æ•™å­¸] æ·±å…¥äº†è§£ CORS (è·¨ä¾†æºè³‡æºå…±ç”¨): å¦‚ä½•æ­£ç¢ºè¨­å®š CORSï¼Ÿ](https://www.shubo.io/what-is-cors/)
- [Feedback wanted: CORS for private networks (RFC1918)](https://developer.chrome.com/articles/cors-rfc1918-feedback/#chrome%27s-plans-to-enable-cors-rfc1918)
- [Private Network Access update: Introducing a deprecation trial](https://developer.chrome.com/blog/private-network-access-update/)
- [Private Network Access: introducing preflights](https://developer.chrome.com/blog/private-network-access-preflight/)